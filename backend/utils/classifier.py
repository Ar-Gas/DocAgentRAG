import os
import time
import re
import shutil
import jieba
import logging
from sklearn.feature_extraction.text import TfidfVectorizer
from sklearn.metrics.pairwise import cosine_similarity
from pathlib import Path
from .retriever import search_documents

logger = logging.getLogger(__name__)

# ===================== 配置：分类与目录 =====================
# 预定义文档类别及其关键词（扩充：40+ 细致分类）
CATEGORY_KEYWORDS = {
    # ==================== 学术论文类 ====================
    '学术论文-计算机': ['论文', '算法', '机器学习', '深度学习', '神经网络', '人工智能', '计算机', '软件工程', '操作系统', '数据库', '网络安全', '分布式', '并行计算', '编译器', '编程语言', '软件工程', '架构设计', '模式识别', '自然语言处理', '计算机视觉', '数据挖掘', '云计算', '边缘计算', '物联网', '区块链', '元宇宙', '实验', '方法', '结论', '参考文献', '摘要', '引言'],
    '学术论文-数学': ['论文', '数学', '微积分', '线性代数', '概率论', '数理统计', '随机过程', '泛函分析', '拓扑学', '数论', '代数学', '几何学', '微分方程', '数值分析', '最优化', '运筹学', '博弈论', '图论', '组合数学', '密码学', '定理', '证明', '引理', '推论', '数学建模'],
    '学术论文-物理': ['论文', '物理', '力学', '热力学', '电磁学', '光学', '量子力学', '相对论', '原子物理', '核物理', '粒子物理', '统计物理', '等离子体', '天体物理', '凝聚态', '材料物理', '声学', '流体力学', '实验物理', '理论物理', '物理学家', '方程', '定律', '定理'],
    '学术论文-化学': ['论文', '化学', '有机化学', '无机化学', '分析化学', '物理化学', '高分子化学', '生物化学', '环境化学', '材料化学', '电化学', '胶体化学', '表面化学', '催化', '分子结构', '化学反应', '合成', '分离', '表征', '光谱', '色谱', '质谱'],
    '学术论文-生物': ['论文', '生物', '细胞生物学', '分子生物学', '遗传学', '生物化学', '生物物理学', '微生物学', '植物学', '动物学', '生态学', '进化生物学', '发育生物学', '神经生物学', '免疫学', '基因工程', '蛋白质', 'DNA', 'RNA', '细胞', '组织', '器官', '系统'],
    '学术论文-医学': ['论文', '医学', '临床医学', '基础医学', '内科学', '外科学', '儿科学', '妇产科学', '眼科学', '耳鼻喉科学', '皮肤病学', '精神病学', '肿瘤学', '心血管', '呼吸系统', '消化系统', '神经系统', '免疫系统', '病理', '药理', '临床试验', '诊断', '治疗', '预后'],
    '学术论文-经济管理': ['论文', '经济学', '管理学', '金融学', '会计学', '市场营销', '人力资源', '战略管理', '组织行为', '运营管理', '项目管理', '质量管理', '财务管理', '投资学', '国际贸易', '电子商务', '宏观经济学', '微观经济学', '计量经济学', '产业经济学', '区域经济学', '劳动经济学'],
    '学术论文-教育': ['论文', '教育学', '教育管理', '课程与教学', '教育技术', '比较教育', '高等教育', '基础教育', '职业教育', '特殊教育', '教育心理学', '教育经济', '教育政策', '教师教育', '学习科学', '远程教育', '混合学习', '教学模式', '教学设计', '评价方法'],
    '学术论文-法学': ['论文', '法学', '宪法', '民法', '刑法', '行政法', '商法', '经济法', '国际法', '环境法', '知识产权', '诉讼法', '证据法', '法律史', '法理学', '法律逻辑', '立法', '司法', '执法', '守法'],
    '学术论文-其他': ['论文', '学术', '研究', '课题', '项目', '学位', '毕业', '学术期刊', '学术会议', ' SCI ', 'EI', '核心期刊', '影响因子', '研究方法', '文献综述', '研究背景', '研究意义'],

    # ==================== 办公文档类 ====================
    '办公-合同协议': ['合同', '协议', '条款', '甲方', '乙方', '签约', '违约', '违约金', '履约', '解约', '补充协议', '意向书', '合作框架', '服务协议', '采购合同', '租赁合同', '劳动合同', '销售合同', '工程合同', '咨询合同', '协议编号', '有效期'],
    '办公-报告总结': ['报告', '总结', '年度总结', '季度总结', '月度总结', '工作报告', '项目报告', '分析报告', '调研报告', '审计报告', '可行性报告', '评估报告', '总结报告', '汇报材料', '述职报告', '述职报告', '工作汇报', '情况汇报', '进展汇报'],
    '办公-通知公告': ['通知', '公告', '关于', '事项', '请及时', '务必', '重要', '紧急', '须知', '提醒', '通告', '启事', '声明', '公示', '发布', '执行', '遵照', '通知事项', '通知对象', '生效日期'],
    '办公-简历求职': ['简历', '求职', '应聘', '个人简历', '工作经历', '教育背景', '专业技能', '项目经验', '自我评价', '期望薪资', '面试', 'offer', '录用', '招聘', '岗位', '职位', '职责', '任职资格', '工作经验', '学历要求'],
    '办公-规章制度': ['制度', '规定', '办法', '准则', '规范', '规程', '条例', '守则', '细则', '章则', '管理制度的', '考核制度', '奖惩制度', '考勤制度', '财务制度', '报销制度', '审批制度', '权限', '职责', '管理'],
    '办公-申请表': ['申请', '申请表', '报名表', '登记表', '审批表', '申请表', '意向表', '登记表', '信息表', '入离职', '入职', '离职', '调动', '转正', '晋升', '加薪', '休假', '出差', '报销', '采购', '用车', '用章'],
    '办公-PPT演示': ['PPT', '演示', '幻灯片', '演示文稿', '汇报PPT', '培训PPT', '介绍PPT', '方案PPT', '计划PPT', '总结PPT', '展示', '演讲', '路演', '发布会', '推介', '宣讲', '汇报演示', '方案演示', '项目路演', '商业计划书'],
    '办公-邮件': ['邮件', 'email', '收件人', '发件人', '抄送', '密送', '主题', '正文', '附件', '回复', '转发', '回复日期', '发件日期', '紧急', '重要', '请查收', '谢谢', '顺祝', '敬礼'],

    # ==================== 技术文档类 ====================
    '技术文档-编程开发': ['编程', '代码', '程序', '开发', '算法', '数据结构', '函数', '类', '接口', '模块', '包', '库', '框架', 'SDK', 'API', 'API接口', '源码', '源代码', '编译', '运行', '调试', '测试', 'Bug', '修复', '优化', '重构'],
    '技术文档-架构设计': ['架构', '设计模式', '微服务', '分布式', '集群', '负载均衡', '缓存', '消息队列', '数据库', '存储', '并发', '异步', '同步', '高可用', '容灾', '备份', '恢复', '监控', '日志', '安全', '认证', '授权', '加密', '解密'],
    '技术文档-操作手册': ['手册', '指南', '教程', '使用说明', '操作指南', '安装指南', '配置指南', '部署指南', '运维手册', '用户手册', '管理员手册', '开发手册', 'API文档', '接口文档', '技术规范', '操作步骤', '使用说明', '注意事项', '常见问题', 'FAQ'],
    '技术文档-产品需求': ['需求', 'PRD', '产品需求', '功能需求', '非功能需求', '用例', '用户故事', '需求分析', '需求规格', '产品设计', '原型设计', '交互设计', 'UI设计', '用户体验', '功能列表', '需求文档', '业务需求', '技术需求'],
    '技术文档-测试文档': ['测试', '测试用例', '测试计划', '测试报告', '测试方案', '功能测试', '性能测试', '压力测试', '集成测试', '单元测试', '回归测试', '黑盒测试', '白盒测试', '自动化测试', '测试脚本', '测试数据', '测试环境', '缺陷', 'Bug'],
    '技术文档-数据库': ['数据库', 'MySQL', 'PostgreSQL', 'Oracle', 'SQL', 'MongoDB', 'Redis', 'Elasticsearch', '数据表', '索引', '视图', '存储过程', '触发器', '事务', '锁', '主键', '外键', '范式', 'SQL语句', '增删改查', '数据库设计', 'ER图', '数据字典'],

    # ==================== 书籍资料类 ====================
    '书籍-编程技术': ['编程', 'Python', 'Java', 'C++', 'Go', 'Rust', 'JavaScript', 'TypeScript', 'PHP', 'Ruby', 'Swift', 'Kotlin', 'C#', 'C语言', '代码', '程序设计', '软件开发', 'Web开发', '移动开发', '前端', '后端', '全栈', '框架', '库', '工具'],
    '书籍-操作系统': ['操作系统', 'Linux', 'Windows', 'Unix', 'macOS', 'Android', 'iOS', '内核', '进程', '线程', '内存管理', '文件系统', '设备驱动', '系统调用', 'Shell', '命令行', '内核编程', '系统编程', '驱动开发', '内核源码'],
    '书籍-网络通信': ['网络', 'TCP', 'HTTP', 'HTTPS', 'DNS', 'FTP', 'SMTP', 'Socket', 'WebSocket', 'REST', 'API', '网关', '路由', '交换机', '路由器', '协议', '网络安全', '防火墙', 'VPN', '代理', '负载均衡', 'CDN', '云计算', '网络编程'],
    '书籍-数据库技术': ['数据库', 'MySQL', 'Oracle', 'PostgreSQL', 'MongoDB', 'Redis', 'Elasticsearch', 'SQL', 'NoSQL', 'NewSQL', '数据库设计', '数据建模', '索引优化', '查询优化', '事务管理', '缓存技术', '数据同步', '数据备份', '数据恢复', '大数据', '数据仓库', 'Hive', 'Spark'],
    '书籍-人工智能': ['人工智能', '机器学习', '深度学习', '神经网络', 'TensorFlow', 'PyTorch', 'Keras', '计算机视觉', '自然语言处理', 'NLP', 'CV', '目标检测', '图像识别', '语音识别', '机器翻译', '推荐系统', '强化学习', '对抗生成', 'GAN', 'Transformer', 'BERT', 'GPT', 'LLM', '大语言模型', 'AI'],
    '书籍-数学基础': ['数学', '高等数学', '线性代数', '概率论', '数理统计', '离散数学', '数值分析', '数学分析', '拓扑学', '泛函分析', '复变函数', '常微分方程', '偏微分方程', '数学建模', '算法', '计算数学', '运筹学', '优化理论'],
    '书籍-经济管理': ['经济学', '管理学', '市场营销', '财务管理', '人力资源', '战略管理', '组织行为', '运营管理', '项目管理', '质量管理', '领导力', '创业', '商业模式', '投资', '金融', '会计', '审计', '商业', '企业', '管理'],
    '书籍-教材-高等教育': ['教材', '教科书', '大学教材', '高等教材', '本科教材', '研究生教材', '课程', '章节', '习题', '答案', '解析', '学习指导', '教学大纲', '考研', '自学', '高等数学', '大学物理', '大学英语', '计算机基础', '专业基础课', '专业课'],
    '书籍-教材-中小学': ['教材', '课本', '教科书', '中小学教材', '初中', '高中', '小学', '语文', '数学', '英语', '物理', '化学', '生物', '历史', '地理', '政治', '同步辅导', '练习册', '中考', '高考', '义务教育'],
    '书籍-其他出版物': ['书籍', '图书', '出版物', '专著', '译著', '编著', '丛书', '全集', '选集', '文集', '手册', '年鉴', '百科全书', '词典', '字典', '辞海', '出版社', 'ISBN', '版次', '印次', '定价', '作者', '译者', '编', '著'],

    # ==================== 数据文档类 ====================
    '数据文档-Excel表格': ['Excel', 'xlsx', 'xls', '表格', '电子表格', '工作表', '工作簿', '单元格', '公式', '函数', '图表', '数据透视表', '宏', 'VBA', '数据分析', '数据处理', '报表', '清单', '明细', '台账', '登记表', '统计表'],
    '数据文档-CSV数据': ['CSV', '数据', '数据文件', '数据导入', '数据导出', '数据格式', '数据清洗', '数据转换', '数据处理', '数据存储', '数据集', '数据表', '字段', '记录', '行', '列', '分隔符', '编码', '数据交换'],
    '数据文档-数据库导出': ['数据库', '导出', '备份', '数据迁移', '数据同步', 'ETL', '数据仓库', '数据湖', '数据集市', 'BI', '商业智能', '数据分析', '数据可视化', '报表', '仪表盘', 'KPI', '指标', '维度', '事实表', '维度表'],

    # ==================== 财务文档类 ====================
    '财务-财务报表': ['财务报表', '资产负债表', '利润表', '现金流量表', '所有者权益', '资产', '负债', '收入', '费用', '利润', '盈余', '折旧', '摊销', '财务分析', '财务报告', '会计报表', '合并报表', '季度报表', '年度报表', '中期报告'],
    '财务-预算决算': ['预算', '决算', '预算编制', '预算执行', '预算分析', '成本核算', '成本控制', '成本管理', '成本分析', '项目预算', '部门预算', '年度预算', '专项预算', '预算审批', '预算调整', '预算外', '超预算', '节余'],
    '财务-发票凭证': ['发票', '凭证', '会计凭证', '原始凭证', '记账凭证', '收据', '报销', '税务发票', '增值税', '专用发票', '普通发票', '电子发票', '发票管理', '凭证管理', '账务处理', '记账', '会计分录', '借方', '贷方'],
    '财务-税务': ['税务', '纳税', '申报', '所得税', '增值税', '印花税', '城建税', '教育费附加', '地方教育附加', '税前', '税后', '税率', '税负', '税收', '税务筹划', '税务筹划', '避税', '合理避税', '税务筹划', '税务会计', '税务申报', '纳税申报'],

    # ==================== 法律文档类 ====================
    '法律-法律法规': ['法律', '法规', '条例', '规章', '规范性文件', '法律条文', '司法解释', '法律效力', '法律规定', '法律依据', '法律责任', '法律后果', '违法', '合法', '非法', '法律程序', '法律适用', '法律管辖'],
    '法律-诉讼文书': ['起诉状', '答辩状', '上诉状', '申诉状', '申请书', '判决书', '裁定书', '调解书', '仲裁裁决', '法庭', '原告', '被告', '第三人', '诉讼请求', '事实与理由', '证据', '质证', '辩论', '审理', '判决'],
    '法律-公证': ['公证书', '公证', '公证员', '公证处', '公证事项', '公证申请', '公证效力', '公证程序', '委托公证', '合同公证', '遗嘱公证', '财产公证', '身份公证', '签名公证', '印鉴公证', '公证收费'],

    # ==================== 会议文档类 ====================
    '会议-会议纪要': ['会议纪要', '会议记录', '会议要点', '会议决议', '会议决定', '会议结论', '会议事项', '会议议题', '会议讨论', '会议发言', '会议表决', '会议共识', '会议分歧', '会议行动', '会议任务', '会议时间', '会议地点', '参会人员', '主持人', '记录人'],
    '会议-议程安排': ['议程', '日程', '会议议程', '会议日程', '会议安排', '会议流程', '会议程序', '会议时间表', '会议计划', '会议议题', '会议顺序', '会议环节', '会议阶段', '会议主持', '会议发言顺序', '讨论顺序', '表决顺序'],
    '会议-签到表': ['签到', '签到表', '参会人员', '签到表', '签到册', '签到名单', '参会名单', '出席人员', '缺席人员', '请假人员', '签到时间', '签到地点', '签到方式', '签到处', '签到台', '参会确认', '参会回执'],

    # ==================== 项目文档类 ====================
    '项目-项目计划': ['项目计划', '项目方案', '项目策划', '项目建议书', '可行性研究', '项目立项', '项目审批', '项目启动', '项目目标', '项目范围', '项目里程碑', '项目进度', '项目排期', '项目时间表', '项目计划书', '项目申报', '项目答辩'],
    '项目-项目总结': ['项目总结', '项目报告', '项目结题', '项目验收', '项目交付', '项目完成', '项目成果', '项目文档', '项目经验', '项目教训', '项目复盘', '项目评估', '项目评审', '项目审计', '项目后评价', '项目归档'],
    '项目-任务分配': ['任务', '分配', '分工', '责任', '职责', '责任人', '负责', '牵头', '配合', '协作', '任务清单', '任务分配', '任务指派', '任务进度', '任务状态', '任务完成', '任务逾期', '任务优先级', '紧急程度'],

    # ==================== 人力资源类 ====================
    '人力-招聘培训': ['招聘', '招聘计划', '招聘信息', '招聘岗位', '招聘要求', '招聘流程', '面试', '笔试', '复试', '终试', '录用', '入职', '培训', '培训计划', '培训内容', '培训教材', '培训考核', '培训效果', '培训记录', '培训证书'],
    '人力-绩效薪酬': ['绩效', '绩效考核', '绩效评估', '绩效管理', '绩效奖金', '薪酬', '工资', '薪资', '奖金', '津贴', '补贴', '福利', '薪酬体系', '薪酬制度', '调薪', '晋升', '晋级', '薪酬调整', '绩效考核表', '绩效面谈'],
    '人力-员工档案': ['员工档案', '人事档案', '档案', '员工信息', '个人信息', '入职登记表', '劳动合同', '保密协议', '离职手续', '离职证明', '工作证明', '收入证明', '社保', '公积金', '档案管理', '人事变动', '转正', '调岗', '离职', '辞退'],

    # ==================== 营销销售类 ====================
    '营销-策划方案': ['营销策划', '推广方案', '活动策划', '策划方案', '营销方案', '推广计划', '活动方案', '促销方案', '品牌策划', '市场策划', '广告策划', '创意策划', '策划书', '营销计划', '推广策略', '活动流程', '预算分配', '预期效果', 'KPI'],
    '营销-市场分析': ['市场分析', '市场调研', '市场报告', '行业分析', '竞争对手', '市场定位', '目标市场', '市场细分', '市场需求', '市场趋势', '市场预测', 'SWOT分析', 'PEST分析', '市场容量', '市场份额', '市场占有率', '消费者分析', '用户画像'],
    '营销-销售': ['销售', '销售合同', '销售订单', '销售合同', '客户', '客户管理', '客户信息', '销售业绩', '销售数据', '销售报表', '销售目标', '销售计划', '销售渠道', '销售策略', '销售技巧', '销售话术', '销售跟进', '成交', '订单', '销售额'],

    # ==================== 教育培训类 ====================
    '教育-教案': ['教案', '教学设计', '教学方案', '教案设计', '教学计划', '教学目标', '教学重点', '教学难点', '教学过程', '教学步骤', '教学方法', '教学手段', '教学活动', '教学环节', '板书设计', '教学反思', '教学评价'],
    '教育-课件': ['课件', 'PPT课件', '教学课件', '演示课件', '课件制作', '教学PPT', '幻灯片', '多媒体课件', '网络课件', '微课', '慕课', '翻转课堂', '课件模板', '教学素材', '图片', '视频', '动画', '音效'],
    '教育-试卷习题': ['试卷', '试题', '习题', '考题', '题目', '选择题', '填空题', '判断题', '简答题', '计算题', '论述题', '作文', '试卷分析', '答题卡', '标准答案', '评分标准', '考试', '测验', '练习'],

    # ==================== 产品文档类 ====================
    '产品-产品介绍': ['产品', '产品介绍', '产品说明', '产品手册', '产品资料', '产品功能', '产品特点', '产品优势', '产品规格', '产品参数', '产品型号', '产品图片', '产品视频', '产品演示', '产品发布会', '产品宣传', '产品推广'],
    '产品-用户手册': ['用户手册', '使用手册', '操作手册', '说明书', '使用说明', '操作指南', '用户指南', '安装指南', '快速入门', '新手教程', '使用教程', '操作教程', '帮助文档', 'FAQ', '常见问题', '故障排除', '问题解答', '技术支持'],

    # ==================== 其他类 ====================
    '其他文档': ['其他', 'misc', 'general', 'various', '杂项', '待分类']
}

EXTENSION_CATEGORY = {
    '.eml': '办公-邮件',
    '.msg': '办公-邮件',
    '.xlsx': '数据文档-Excel表格',
    '.xls': '数据文档-Excel表格',
    '.csv': '数据文档-CSV数据',
    '.pdf': None,
    '.docx': '办公-其他',
    '.doc': '办公-其他',
    '.pptx': '办公-PPT演示',
    '.ppt': '办公-PPT演示',
    '.txt': '其他文档',
    '.md': '其他文档',
    '.json': '数据文档-其他',
    '.xml': '数据文档-其他',
    '.zip': '其他文档',
    '.rar': '其他文档',
    '.7z': '其他文档',
    '.jpg': '其他文档',
    '.jpeg': '其他文档',
    '.png': '其他文档',
    '.gif': '其他文档',
    '.mp3': '其他文档',
    '.mp4': '其他文档',
    '.wav': '其他文档',
    '.avi': '其他文档',
    '.mov': '其他文档',
}

# 全局变量（懒加载）
_vectorizer = None
_category_vectors = None
_category_names = None

# ===================== 工具：中文分词 =====================
def _chinese_tokenizer(text):
    """自定义中文分词器，用于TF-IDF"""
    return jieba.lcut(text)

# ===================== 工具：懒加载分类模型 =====================
def _init_classifier():
    """懒加载TF-IDF向量化器和类别特征，避免启动时初始化"""
    global _vectorizer, _category_vectors, _category_names
    if _vectorizer is not None and _category_vectors is not None:
        return

    logger.info(f"初始化文档分类模型，共 {len(CATEGORY_KEYWORDS)} 个类别...")
    category_texts = []
    _category_names = list(CATEGORY_KEYWORDS.keys())
    for category, keywords in CATEGORY_KEYWORDS.items():
        feature_text = f"{category} {' '.join(keywords * 3)}"
        category_texts.append(feature_text)

    _vectorizer = TfidfVectorizer(
        tokenizer=_chinese_tokenizer,
        stop_words=['的', '了', '和', '是', '在', '对', '与', '等', '了', '着', '过', '把', '被', '让', '给', '向', '往', '从', '到', '为', '以', '及', '或', '但', '而', '且', '如果', '因为', '所以', '虽然', '但是'],
        ngram_range=(1, 2),
        max_features=10000,
        min_df=1,
        max_df=0.95
    )

    _category_vectors = _vectorizer.fit_transform(category_texts)
    logger.info(f"文档分类模型初始化完成，共 {_category_vectors.shape[0]} 个类别")

# ===================== 核心：基于文件名的快速分类 =====================
def _classify_by_filename(filename: str) -> tuple:
    """
    基于文件名进行快速分类
    :param filename: 文件名
    :return: (category: str or None, confidence: float)
    """
    if not filename:
        return None, 0.0

    filename_lower = filename.lower()

    name_category_rules = [
        # ==================== 高优先级：具体类别 ====================
        # 财务类 - 优先匹配
        (['财务报表', '资产负债表', '利润表', '现金流量表'], '财务-财务报表'),
        (['预算', '决算', '成本核算'], '财务-预算决算'),
        (['发票', '报销'], '财务-发票凭证'),
        (['税务', '纳税', '申报', '所得税', '增值税'], '财务-税务'),

        # 合同协议类
        (['合同', '协议', '合约', '条款', '劳动合同', '雇佣合同', '采购合同', '销售合同'], '办公-合同协议'),

        # 项目类
        (['项目计划', '项目方案', '可行性', '项目立项', '项目策划'], '项目-项目计划'),
        (['项目总结', '项目报告', '项目结题', '项目验收'], '项目-项目总结'),
        (['项目', '计划', '方案'], '项目-项目计划'),

        # 营销类
        (['市场分析', '市场调研', '行业分析'], '营销-市场分析'),
        (['营销', '推广', '活动策划', '策划方案'], '营销-策划方案'),
        (['销售', '客户', '订单'], '营销-销售'),

        # 产品类 - 用户手册
        (['用户手册', '使用手册', '说明书', '操作指南', '使用说明', '安装指南'], '产品-用户手册'),
        (['产品介绍', '产品说明', '产品手册'], '产品-产品介绍'),

        # 办公文档类
        (['报告', '总结', '汇报', '述职', '年度总结', '季度总结', '月度总结', '分析报告'], '办公-报告总结'),
        (['通知', '公告', '通告', '启事', '关于'], '办公-通知公告'),
        (['简历', '求职', '应聘', '个人简历'], '办公-简历求职'),
        (['制度', '规定', '办法', '准则', '规范'], '办公-规章制度'),
        (['申请', '报名', '登记表'], '办公-申请表'),
        (['ppt', '演示', '幻灯片'], '办公-PPT演示'),
        (['邮件', 'email'], '办公-邮件'),

        # 会议类
        (['会议纪要', '会议记录', '会议决议'], '会议-会议纪要'),
        (['议程', '日程'], '会议-议程安排'),
        (['签到'], '会议-签到表'),

        # 人力资源类
        (['招聘', '面试', '培训'], '人力-招聘培训'),
        (['绩效', '考核'], '人力-绩效薪酬'),
        (['薪酬', '薪资', '工资', '奖金'], '人力-绩效薪酬'),
        (['档案', '劳动合同', '入职', '离职'], '人力-员工档案'),

        # 教育类
        (['教案', '教学设计'], '教育-教案'),
        (['课件', '教学'], '教育-课件'),
        (['试卷', '试题', '习题', '考题'], '教育-试卷习题'),

        # 书籍类 - 编程技术
        (['编程', 'python', 'java', 'c++', 'rust', 'golang', 'javascript', '算法', '数据结构', '计算机', '网络', '数据库', '操作系统', 'linux', 'ai', '人工智能', '机器学习', '深度学习', 'cpp', 'tutorial', 'guide', '编程指南', '编程入门', '实战', '进阶', '入门', '编程'], '书籍-编程技术'),
        (['操作系统', 'linux', 'unix', 'windows', '内核'], '书籍-操作系统'),
        (['网络', 'tcp', 'http', 'socket', 'https'], '书籍-网络通信'),
        (['数据库', 'mysql', 'redis', 'mongodb', 'postgresql', 'oracle', 'sql'], '书籍-数据库技术'),
        (['人工智能', '机器学习', '深度学习', '神经网络', 'tensorflow', 'pytorch', 'gpt', 'llm', 'nlp', 'cv', 'cuda', 'gpu'], '书籍-人工智能'),
        (['数学', '高等数学', '线性代数', '概率论', '微积分'], '书籍-数学基础'),
        (['经济学', '管理学', '营销', '财务', '会计', '金融'], '书籍-经济管理'),
        (['教材', '教科书', '大学', '课程', '章节', '习题'], '书籍-教材-高等教育'),
        (['小学', '中学', '初中', '高中', '中考', '高考'], '书籍-教材-中小学'),
        (['book', 'ebook'], '书籍-其他出版物'),

        # 学术论文类
        (['论文', '学术', '毕业', '学位', '课题', '研究'], '学术论文-其他'),
        (['计算机', '软件', '算法', '人工智能', '机器学习'], '学术论文-计算机'),
        (['物理', '化学', '生物', '医学', '教育', '法学'], '学术论文-其他'),

        # 技术文档类
        (['代码', '源码', 'source', '编程'], '技术文档-编程开发'),
        (['架构', '设计模式', '微服务'], '技术文档-架构设计'),
        (['手册', '指南', '教程', '文档', '说明'], '技术文档-操作手册'),
        (['需求', 'prd', '功能'], '技术文档-产品需求'),
        (['测试', '用例', 'bug', '缺陷'], '技术文档-测试文档'),

        # 法律类
        (['法律', '法规', '条例'], '法律-法律法规'),
        (['起诉', '答辩', '判决', '裁定', '诉讼'], '法律-诉讼文书'),
        (['公证', '公证书'], '法律-公证'),
    ]

    for keywords, category in name_category_rules:
        for kw in keywords:
            if kw in filename_lower:
                return category, 0.8

    return None, 0.0

# ===================== 核心：传统方法分类 ======================
def classify_by_content(content, filename=""):
    """
    基于内容和文件名的文档分类
    :param content: 文档内容
    :param filename: 文件名
    :return: (categories: list, confidence: float)
    """
    try:
        _init_classifier()

        filename_category, filename_confidence = _classify_by_filename(filename)
        if filename_category and filename_confidence > 0.5:
            logger.info(f"通过文件名分类：{filename} -> {filename_category} (置信度: {filename_confidence})")
            return [filename_category], filename_confidence

        ext = os.path.splitext(filename)[1].lower()
        if ext in EXTENSION_CATEGORY and EXTENSION_CATEGORY[ext] is not None:
            logger.info(f"通过扩展名分类：{filename} -> {EXTENSION_CATEGORY[ext]}")
            return [EXTENSION_CATEGORY[ext]], 0.85

        if not content or len(content.strip()) < 50:
            if filename_category:
                return [filename_category], 0.6
            return ['其他文档'], 0.5

        content = re.sub(r'\s+', ' ', content)
        combined_text = f"{filename} {content}"

        content_vector = _vectorizer.transform([combined_text])

        similarities = cosine_similarity(content_vector, _category_vectors)[0]

        category_scores = list(zip(_category_names, similarities))
        category_scores.sort(key=lambda x: x[1], reverse=True)

        top_score = category_scores[0][1]
        if top_score < 0.05:
            if filename_category:
                return [filename_category], 0.5
            return ['其他文档'], 0.3

        threshold = max(0.05, top_score * 0.3)
        categories = [cat for cat, score in category_scores if score >= threshold][:3]

        if not categories:
            categories = [category_scores[0][0]]
            confidence = category_scores[0][1] * 0.5
        else:
            confidence = category_scores[0][1]

        if filename_category and filename_category not in categories:
            if categories[0] in CATEGORY_KEYWORDS:
                categories.insert(0, filename_category)
                categories = categories[:3]

        return categories, round(min(confidence, 1.0), 2)
    except Exception as e:
        logger.error(f"内容分类失败: {str(e)}")
        return ['其他文档'], 0.5

# ===================== 核心：自动创建分类目录并移动文件 =====================
def create_classification_directory(doc_info, categories, base_dir=None):
    """
    自动创建分类目录并移动文件
    :param doc_info: 文档信息
    :param categories: 分类结果列表
    :param base_dir: 分类目录根目录
    :return: (success: bool, target_path: str)
    """
    try:
        if not categories or not doc_info.get('filepath'):
            return False, ""

        if base_dir is None:
            base_dir = Path(os.path.dirname(os.path.dirname(os.path.abspath(__file__)))) / "classified_docs"
        base_dir = Path(base_dir)
        base_dir.mkdir(parents=True, exist_ok=True)

        primary_category = categories[0]
        category_dir = base_dir / primary_category
        category_dir.mkdir(parents=True, exist_ok=True)

        original_path = Path(doc_info['filepath'])
        if not original_path.exists():
            logger.warning(f"原文件不存在，跳过移动：{original_path}")
            return False, ""

        target_path = category_dir / original_path.name
        counter = 1
        while target_path.exists():
            stem = original_path.stem
            suffix = original_path.suffix
            target_path = category_dir / f"{stem}_{counter}{suffix}"
            counter += 1

        shutil.move(str(original_path), str(target_path))
        logger.info(f"文件已移动到分类目录：{original_path.name} -> {target_path}")

        return True, str(target_path)
    except Exception as e:
        logger.error(f"创建分类目录/移动文件失败: {str(e)}")
        return False, ""

# ===================== 完整：文档分类流水线 =====================
def classify_document(doc_info, auto_move=True, base_dir=None):
    """
    完整的文档分类流水线
    :param doc_info: 文档信息
    :param auto_move: 是否自动创建目录并移动文件
    :param base_dir: 分类目录根目录
    :return: 分类结果字典
    """
    try:
        content = doc_info.get('preview_content', '')
        filename = doc_info.get('filename', '')
        filepath = doc_info.get('filepath', '')

        if not content and not filename:
            logger.error("文档信息缺失，无法分类")
            return {
                "document_id": doc_info.get('id', ''),
                "original_filename": filename,
                "classification_result": {
                    "categories": ['其他文档'],
                    "confidence": 0.5,
                    "error": "文档信息缺失"
                },
                "processing_details": {"error": "文档信息缺失"},
                "recommended_actions": ["检查文档信息"]
            }

        logger.info(f"开始分类文档：{filename}")

        categories, confidence = classify_by_content(content, filename)

        moved = False
        target_path = ""
        if auto_move and categories[0] != '其他文档':
            moved, target_path = create_classification_directory(doc_info, categories, base_dir)

        classification_result = {
            "categories": categories,
            "confidence": confidence,
            "classification_time": time.strftime("%Y-%m-%dT%H:%S:%S"),
            "details": {
                "filename_analysis": f"基于文件名 '{filename}' 的分析",
                "content_analysis": "基于文件名+扩展名+内容的TF-IDF+余弦相似度分类",
                "extension": filepath.split('.')[-1].lower() if filepath else ''
            },
            "suggested_folders": [f"{cat}/{filename}" for cat in categories],
            "actual_path": target_path if moved else ""
        }

        final_result = {
            "document_id": doc_info.get('id', ''),
            "original_filename": filename,
            "original_path": filepath,
            "classification_result": classification_result,
            "processing_details": {
                "content_length": len(content),
                "auto_moved": moved,
                "timestamp": time.strftime("%Y-%m-%dT%H:%M:%S")
            },
            "recommended_actions": [
                "查看分类结果是否准确",
                "如不准确可手动调整分类",
                "基于分类结果设置访问权限"
            ] if not moved else [
                "分类完成，文件已移动到对应目录"
            ]
        }

        logger.info(f"文档分类完成：{filename} -> {categories[0]} (置信度: {confidence})")
        return final_result
    except Exception as e:
        logger.error(f"文档分类失败: {str(e)}")
        return {
            "document_id": doc_info.get('id', ''),
            "original_filename": doc_info.get('filename', ''),
            "classification_result": {
                "categories": ['其他文档'],
                "confidence": 0.5,
                "error": str(e)
            },
            "processing_details": {"error": str(e)},
            "recommended_actions": ["检查文档格式", "重新尝试分类"]
        }
